<!DOCTYPE html>
<html>
<head>
    <title>Chat Interface</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #000;
        }
        .button-style:hover {
            background-color: #444;
        }
        #sidebar {
            width: 20%;
            background-color: #333;
            color: #0f0;
            overflow-y: auto;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
        }
        #chat-container {
            width: 80%;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: #000;
        }
        #chat-box {
            flex-grow: 1;
            border: none;
            padding: 10px;
            overflow-y: auto;
            background-color: #000;
            color: #0f0;
        }
        #input-box {
            padding: 10px;
            border: 1px solid #0f0;
            background-color: #000;
            color: #0f0;
            width: calc(100% - 22px);
        }
        #new-chat-button {
            padding: 10px 20px;
            background-color: #333;
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        #new-chat-button:hover {
            background-color: #444;
        }
        .message {
            font-family: 'Courier New', monospace;
            padding: 5px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #000;
            color: #0f0;
            word-wrap: break-word;
        }
        .user-message {
            text-align: right;
        }
        .ai-message {
            text-align: left;
        }
        @media (max-width: 768px) {
            #sidebar {
                width: 30%;
            }
            #chat-container {
                width: 70%;
            }
        }
        @keyframes spinner {
        to {transform: rotate(360deg);}
        }
        .loading-spinner {
        border: 4px solid #333; /* Light grey */
        border-top: 4px solid #0f0; /* Green */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spinner 1s linear infinite;
        }
        .code-block {
            background: #333; /* Dark background for better contrast */
            color: #0f0; /* Light text color */
            padding: 10px; /* Padding inside the code block */
            margin: 10px 0; /* Margin around the code block */
            white-space: pre-wrap; /* Preserves spaces and line breaks */
            overflow-x: auto; /* Adds horizontal scrollbar if needed */
            display: block; /* Ensures the code block is full-width */
            font-family: 'Courier New', monospace; /* Monospace font for code */
            border-radius: 4px; /* Rounded corners for the code block */
        }
        .dropbtn {
            background-color: #333;
            color: #0f0;
            padding: 5px 8px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            outline: none;
            position: relative;
            float: right;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #333;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown-content a {
            color: #0f0;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        
        /* Positioning the dropdown correctly */
        .session-entry .dropdown {
            position: static;
        }
        
        .session-entry:hover .dropdown-content {
            display: block;
        }

        .session-entry {
            position: relative;
            padding: 10px 20px; /* Adjust padding as needed */
            margin-bottom: 5px;
            border: 1px solid #0f0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between; /* This will push content to each end */
            align-items: center;
            background-color: #333;
        }
        .button-style {
            background-color: transparent;
            color: #0f0;
            border: none;
            text-align: left;
            padding: 10px 0px; /* Adjust padding to match the height of .dropbtn */
            margin: 0;
            flex-grow: 1; /* Ensures the button expands to fill the space */
            cursor: pointer;
        }               

        .show {display: block;}

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            position: relative;
            background-color: #333;
            margin: 10% auto; /* 10% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 50%; /* Could be more or less, depending on screen size */
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Add this to make the button more visually part of the modal */
        #project-selection-modal button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #0f0; /* Green background */
            color: #000; /* Black text color */
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #project-selection-modal button:hover {
            background-color: #0c0; /* Darker green */
        }

        .project-list-item {
            padding: 10px 20px;
            margin: 5px 0;
            background-color: #333;
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-list-item button {
            background-color: #222;
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .project-list-item:hover {
            background-color: #444;
        }

        .project-list-item button:hover {
            background-color: #0f0;
            color: #000;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button id="new-chat-button">Select Project</button>
        <h2>Directory</h2>
        <!-- Project Directory will go here -->
    </div>
    <div id="chat-container">
        <div id="loadingIndicator" style="display: none;">
            <div class="loading-spinner"></div>
          </div>          
        <div id="chat-box"></div>
        <input type="text" id="input-box" placeholder="Type your message here..." onkeypress="sendMessage(event)">
    </div>
    <div id="project-selection-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Choose a Project</h2>
            <div id="project-list">
                <!-- Dynamically generated list of projects will be inserted here -->
            </div>
            <button onclick="createNewChat()">+ New Project</button>
        </div>
    </div>  
    <script>
        
        const appState = {
            currentSessionId: null,

            initializeApp: () => {
                customLog("Initializing app...");
                appState.setupEventListeners();
                appState.setupModalEventListeners();
                appState.setupDropdowns();
            },

            setupEventListeners: function() {
                customLog("Setting up event listeners...");
            
                document.getElementById('new-chat-button').addEventListener('click', function() {
                    event.stopPropagation();
                    modal.open();
                });
                document.querySelector('.close-button').addEventListener('click', modal.close);
                
                document.getElementById('project-selection-modal').addEventListener('click', handleModalClick);
                document.querySelector('#project-selection-modal button').addEventListener('click', createNewChat);
                // Event delegation for session items and dropdowns
                document.getElementById('project-list').addEventListener('click', handleProjectListClick);
                document.addEventListener('click', closeAllDropdownsOutsideClick);
                
                // Input box event
                document.getElementById('input-box').addEventListener('keypress', sendMessage);
            },

            setupModalEventListeners: function() {
                customLog("Setting up modal event listeners...");
                const projectList = document.getElementById('project-list');
                // Use event delegation for project list items
                projectList.addEventListener('click', function(event) {
                    if (event.target && event.target.matches('.project-list-item span')) {
                        const sessionId = event.target.closest('.project-list-item').dataset.sessionId;
                        customLog(`Session list item ${sessionId} clicked.`);
                        loadSession(sessionId);
                    }
                });
            },

            setupDropdowns: function() {
                customLog("Setting up dropdowns...");
                document.querySelectorAll('.dropbtn').forEach(function(dropbtn) {
                    dropbtn.onclick = function(event) {
                        // Prevent the event from closing dropdowns
                        event.stopPropagation();
                        // Close all other dropdowns
                        closeAllDropdowns();
                        // Toggle this dropdown
                        this.nextElementSibling.classList.toggle('show');
                    };
                });
            },


        };

        // Initialization app
        window.addEventListener('DOMContentLoaded', () => appState.initializeApp());

        function customLog(message, isError = false) {
            let logObject = { message, isError };
            fetch('/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(logObject),
            });
        }

        // Modal handling
        const modal = (function() {
            const projectModal = document.getElementById('project-selection-modal');
        
            function closeModal() {
                customLog("Closing modal...");
                projectModal.style.display = 'none';
            }

        // Public API
            return {
                open: function() {
                    console.log("Current state before modal open:", appState);
                    customLog("Opening modal...");
                    projectModal.style.display = 'block';
                    loadSessionsIntoModal();
                },
                close: closeModal
            };
        })();

        function createSessionItem(session) {
            customLog(`Creating session item with session_id: ${session.session_id} and name: ${session.name}`);
            customLog("Creating session item...");
            const sessionItem = document.createElement('div');
            sessionItem.className = 'project-list-item';
            sessionItem.dataset.sessionId = session.session_id;
            customLog("Session name: " + session.name);

            const sessionName = document.createElement('span');
            sessionName.className = 'session-name';
            sessionName.textContent = session.name || 'Session ' + session.session_id;
            customLog("Session name text content: " + sessionName.textContent);

            // Dropdown and its contents
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown';
            const dropbtn = document.createElement('button');
            dropbtn.className = 'dropbtn';
            dropbtn.textContent = '...';
            dropbtn.onclick = function(event) {
                event.stopPropagation();
                this.nextElementSibling.classList.toggle('show');
            };
            dropdown.appendChild(dropbtn);

            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';
            dropdownContent.appendChild(createDropdownOption('Rename', () => promptForNewSessionName(session.session_id, sessionName)));

            dropdownContent.appendChild(createDropdownOption('Delete', () => deleteChat(session.session_id, sessionItem)));
            dropdown.appendChild(dropdownContent);

            sessionItem.appendChild(sessionName);
            sessionItem.appendChild(dropdown);

            return sessionItem;
        }

        function promptForNewSessionName(sessionId, sessionNameElement) {
            const currentName = sessionNameElement.textContent;
            const newName = prompt('Enter new session name:', currentName);
            if (newName && newName !== currentName) {
                renameSession(sessionId, newName, sessionNameElement);
            }
        }

        function createDropdownOption(text, action) {
            const option = document.createElement('a');
            option.textContent = text;
            option.href = '#';
            option.onclick = function(event) {
                event.preventDefault();
                action();
            };
            return option;
        }


        function handleProjectListClick(event) {
            event.stopPropagation();
            const sessionItem = event.target.closest('.project-list-item');
            customLog("Clicked on Session item: " + sessionItem);
            if (!sessionItem) return;

            const sessionId = sessionItem.dataset.sessionId;
            if (event.target.classList.contains('rename-option')) {
                const sessionNameElement = sessionItem.querySelector('span.session-name'); // Ensure this selector targets the correct span
                customLog("Session name element: " + sessionNameElement);
                const currentName = sessionNameElement.textContent;
                const newName = prompt('Enter new session name:', currentName);
                if (newName && newName !== currentName) {
                    renameSession(sessionId, newName, sessionNameElement);
                }
            } else if (event.target.classList.contains('delete-option')) {
                if (confirm('Are you sure you want to delete this session?')) {
                    deleteChat(sessionId, sessionItem);
                }
            }
            closeAllDropdowns();
        }

        // Toggles a dropdown menu
        function toggleDropdown(buttonElement) {
            closeAllDropdowns();
            buttonElement.nextElementSibling.classList.toggle('show');
        }

        function closeAllDropdownsOutsideClick(event) {
            if (!event.target.matches('.dropbtn')) {
                closeAllDropdowns();
            }
        }

        // Handles modal click to close it on outside click
        function handleModalClick(event) {
            customLog("Handling modal click...");
            if (event.target.classList.contains('modal')) {
                modal.close();
            }
        }

        function createNewChat() {
            customLog("Preparing for new chat...");
            appState.currentSessionId = null;
            document.getElementById('chat-box').innerHTML = ''; // Clear previous chat
            modal.close();
        }

        function loadSessionsIntoModal() {
            customLog("Loading sessions into modal...");
            fetch('/get-sessions', { cache: 'no-cache' })
                .then(response => response.json())
                .then(sessions => {
                    if (!sessions || !Array.isArray(sessions)) {
                        throw new Error('Sessions is not an array');
                    }
                    console.log('Sessions fetched:', JSON.stringify(sessions, null, 2));
                    const projectList = document.getElementById('project-list');
                    projectList.innerHTML = '';
                    sessions.forEach(session => {
                        console.log(`Creating session item for session_id: ${session.session_id}, name: ${session.name}`); // Log each session
                        const sessionItem = createSessionItem(session);
                        projectList.appendChild(sessionItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching sessions:', error);
                });  
        }

        document.addEventListener('click', function(event) {
            // Handle all document click events here and delegate as necessary
            const projectList = document.getElementById('project-list');
            if (projectList.contains(event.target)) {
                if (event.target.matches('.session-entry span')) {
                    const sessionId = event.target.dataset.sessionId;
                    loadSession(sessionId);
                }
                closeAllDropdowns();
            }
        });

        function closeAllDropdowns() {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }

        function createAndSendNewChat(message) {
            if (appState.currentSessionId === null) {
                return fetch('/new-session', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        appState.currentSessionId = data.session_id;
                        customLog("New chat session created: " + appState.currentSessionId);
                        return sendAndDisplayMessage(message);
                    });
            } else {
                return sendAndDisplayMessage(message);
            }
        }

        function sendMessage(event) {
            if (event.key === "Enter") {
                // Prevents the default action to ensure form is not submitted traditionally
                event.preventDefault();

                let inputBox = document.getElementById('input-box');
                let message = inputBox.value.trim();
                if (message === '') return; // Prevent sending empty messages
                inputBox.value = '';

                // Append message and show loading indicator
                appendMessage('You: ' + message, 'user');
                showLoadingIndicator(true);

                // If there is no session, create one, otherwise send the message.
                if (appState.currentSessionId === null) {
                    createAndSendNewChat(message);
                } else {
                    sendAndDisplayMessage(message);
                }
            }
        }


        function applyTextStyles(text) {
            // Headers
            text = text.replace(/(###\s(.*))/g, '<h3>$2</h3>');
            text = text.replace(/(##\s(.*))/g, '<h2>$2</h2>');
            text = text.replace(/(#\s(.*))/g, '<h1>$2</h1>');

            // Lists
            text = text.replace(/(\n- (.*))/g, '<li>$2</li>').replace(/<li>(.*?)<\/li>/g, '<ul>$&</ul>');
            text = text.replace(/(\n\d+\.\s(.*))/g, '<li>$2</li>').replace(/<li>(.*?)<\/li>/g, '<ol>$&</ol>');
            
            // Links
            text = text.replace(/(http[s]?:\/\/[^\s]+)/g, '<a href="$1">$1</a>');

            // Line Breaks
            text = text.replace(/\n\n/g, '<p></p>');
            text = text.replace(/\n/g, '<br>');

            // Bold and Italics
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // text = text.replace(/```[\s\S]*?```/g, '<code-block>$1</code-block>');
            
            return text;
        }

        function appendMessage(message, sender) {
            let chatBox = document.getElementById('chat-box');
            const codeBlockRegex = /```[\s\S]*?```/g;
            let match;
            let lastIndex = 0;
            let formattedMessage = '';

            // Insert a line break if the last message wasn't from the same sender
            let lastChild = chatBox.lastElementChild;
            if (lastChild && !lastChild.classList.contains(sender + '-message')) {
                formattedMessage += '<br>'; // Add a single line break
            }

            while ((match = codeBlockRegex.exec(message)) !== null) {
                let textBeforeCode = message.substring(lastIndex, match.index);
                if (textBeforeCode) {
                    formattedMessage += applyTextStyles(textBeforeCode);
                }
                let codeContent = match[0].slice(3, -3);
                formattedMessage += `<pre class="code-block"><code>${codeContent}</code></pre>`;
                lastIndex = match.index + match[0].length;
            }

            if (lastIndex < message.length) {
                let remainingText = message.substring(lastIndex);
                formattedMessage += applyTextStyles(remainingText);
            }

            // Append the formatted message to the chat box
            let messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + sender + '-message'; // Ensure to use sender-message for styling
            messageDiv.innerHTML = formattedMessage;
            chatBox.appendChild(messageDiv);

            // Scroll to the bottom of the chat box
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function sendAndDisplayMessage(message) {
            customLog("Sending and displaying message...");
            // Return the fetch promise
            return fetch('/query?session_id=' + appState.currentSessionId + '&query=' + encodeURIComponent(message))
                .then(response => response.text())
                .then(data => {
                    showLoadingIndicator(false); // Hide loading indicator
                    //appendMessage('\n');
                    appendMessage('AI: ' + data, 'ai');
                }).catch(error => {
                    showLoadingIndicator(false); // Hide loading indicator
                    customLog('Error sending message:' + error, true);
                });
        }

        function showLoadingIndicator(show) {
            let loadingIndicator = document.getElementById('loadingIndicator');
            if (show) {
                loadingIndicator.style.display = 'block';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }

        function loadSessions() {

            customLog("Loading sessions...");

            fetch('/get-sessions')
                .then(response => response.json())
                .then(sessions => {
                    if (!sessions || !Array.isArray(sessions)) {
                        throw new Error('Sessions is not an array');
                    }
                }).catch(error => {
                    customLog('Error fetching sessions: ' + error, true);
                });
        }

        function loadSession(sessionId) {
            customLog(`Loading session: ${sessionId}, currentSessionId: ${appState.currentSessionId}`);
            customLog("Loading session:" + sessionId);
            fetch('/get-session-history?session_id=' + sessionId)
                .then(response => response.json())
                .then(history => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = ''; // Clear previous chat

                    // Process each message and append it with a line break
                    history.forEach(item => {
                        appendMessage(item.content, item.role === 'user' ? 'user' : 'ai');
                    });
                    appState.currentSessionId = sessionId; // Update current session ID
                }).catch(error => {
                    customLog('Error loading session:' + error, true);
                }).finally(() => {
                    // This ensures the modal is toggled after the session is loaded or if there is an error
                    modal.close();
                });
        }

        function deleteChat(sessionId, sessionItem) {
            
            fetch(`/delete-session?session_id=${sessionId}`, {
                method: 'DELETE',
            }).then(response => {
                if (!response.ok) throw new Error('Network response was not ok.');
                if (appState.currentSessionId === sessionId) {
                    appState.currentSessionId = null; 
                    document.getElementById('chat-box').innerHTML = '';
                }
                sessionItem.remove();
                customLog("Chat session deleted successfully.");
            }).catch(error => {
                customLog("Error deleting session: " + error, true);
            });
        }

        function renameSession(sessionId, newName, sessionNameElement) {
            console.log(`Attempting to rename session: ${sessionId} to newName: ${newName}`);
            if (!sessionNameElement) {
                customLog("Session name element not found for renaming.");
                return;
            }

            if (!(sessionNameElement instanceof HTMLElement)) {
                customLog("Session name element is not an HTML element.");
                return;
            }

            if (typeof newName !== 'string' || !newName.trim()) {
                customLog("New name is not a valid non-empty string.");
                return;
            }

            const requestBody = JSON.stringify({
                sessionId: sessionId.toString(), // Ensure it's a string
                newName: newName.trim(), // Trim any whitespace
            });

            fetch(`/rename-session`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: requestBody,
            }).then(response => {
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                return response.json(); // Assuming the server sends back a JSON response
            }).then(data => {
                console.log(`Successfully renamed session: ${sessionId} to newName: ${newName}`);
                sessionNameElement.textContent = newName; // Update the session name
                customLog("Session renamed successfully.");
                console.log(`Updated session name element for session: ${sessionId}`, sessionNameElement);
            }).catch(error => {
                customLog("Error renaming session: " + error, true);
            });
        }
    </script>  
</body>
</html>
